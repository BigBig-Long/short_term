<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>房屋类型分析</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Premium Multipurpose Admin & Dashboard Template" name="description">
    <meta content="Themesdesign" name="author">
    <meta name="referrer" content="no-referrer"/>

    <link href="/static/css/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/icons.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/app.min.css" rel="stylesheet" type="text/css">

</head>

<body data-topbar="colored">

<!-- Begin page -->
<div id="layout-wrapper">

    <header id="page-topbar">
        <div class="navbar-header">
            <div class="d-flex">
                <!-- LOGO -->
                <div class="navbar-brand-box">
                    <a href="#" class="logo logo-dark" style="font-size:20px;font-weight: bold">
                        房屋数据分析预测系统
                    </a>

                    <a href="" class="logo logo-light">
                                <span class="logo-sm">
                                    <img src="/picture/logo-sm-light.png" alt="" height="22">
                                </span>
                        <span class="logo-lg">
                                    <img src="/picture/logo-light.png" alt="" height="20">
                                </span>
                    </a>
                </div>

                <button type="button" class="btn btn-sm px-3 font-size-24 header-item waves-effect"
                        id="vertical-menu-btn">
                    <i class="mdi mdi-backburger"></i>
                </button>

                <!-- App Search-->
                <form class="app-search d-none d-lg-block">
                    <div class="position-relative">
                        <input onclick="toSearch()" type="text" class="form-control" placeholder="Search...">
                        <span class="mdi mdi-magnify"></span>
                        <script>
                            const toSearch = () => {
                                window.location.href = 'http://localhost:5000/page/search'
                            }
                        </script>
                    </div>
                </form>
            </div>

            <div class="d-flex">

                <div class="dropdown d-inline-block">
                    <button type="button" class="btn header-item waves-effect" id="page-header-user-dropdown"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="d-none d-sm-inline-block ml-1">{{ username }}</span>
                        <i class="mdi mdi-chevron-down d-none d-sm-inline-block"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="/user/logOut"><i
                                class="mdi mdi-logout font-size-16 align-middle mr-1"></i> 退出登录</a>
                    </div>
                </div>

            </div>
        </div>

    </header>

    <!-- ========== Left Sidebar Start ========== -->
    <div class="vertical-menu">

        <div data-simplebar="" class="h-100">

            <!--- Sidemenu -->
            <div id="sidebar-menu">
                <!-- Left Menu Start -->
                <ul class="metismenu list-unstyled" id="side-menu">
                    <li class="menu-title">首页菜单</li>

                    <li>
                        <a href="/page/home" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-airplay"></i></div>
                            <span>首页</span>
                        </a>
                    </li>

                    <li>
                        <a href="/page/search" class=" waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-schedule"></i></div>
                            <span>搜索分类</span>
                        </a>
                    </li>

                    <li>
                        <a href="/page/tableData" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-comment-message"></i></div>
                            <span>数据操作</span>
                        </a>
                    </li>
                    <li class="menu-title">数据可视化</li>

                    <li>
                        <a href="/page/priceChar" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-sign-in-alt"></i></div>
                            <span>房屋价格分析</span>
                        </a>
                    </li>

                    <li>
                        <a href="/page/detailChar" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-grids"></i></div>
                            <span>房屋详情分析</span>
                        </a>
                    </li>


                    <li>
                        <a href="/page/typeChar" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-box"></i></div>
                            <span>房屋类型分析</span>
                        </a>
                    </li>

                    <li>
                        <a href="/page/anthorChar" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-layer-group"></i></div>
                            <span>房屋状态分析</span>
                        </a>
                    </li>
                    <li class="menu-title">特征分析</li>
                    <li>
                        <a href="/page/companyCloud" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-object-ungroup"></i></div>
                            <span>成交量特征分析</span>
                        </a>
                    </li>

                    <li>
                        <a href="/page/tagCloud" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-table"></i></div>
                            <span>市场热度分析</span>
                        </a>
                    </li>
                    <li class="menu-title">人工智能</li>

                    <li>
                        <a href="/page/pricePred" class="waves-effect">
                            <div class="d-inline-block icons-sm mr-1"><i class="uim uim-document-layout-left"></i></div>
                            <span>房价预测</span>
                        </a>
                    </li>


                </ul>

            </div>
            <!-- Sidebar -->
        </div>
    </div>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">

        <div class="page-content">

            <!-- Page-Title -->
            <div class="page-title-box">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="page-title mb-1">房屋类型分析</h4>
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">首页菜单</a></li>
                                <li class="breadcrumb-item active">房屋类型分析</li>
                            </ol>
                        </div>
                    </div>

                </div>
            </div>
            <!-- end page title end breadcrumb -->

            <div class="page-content-wrapper">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">

                                    <h4 class="header-title">城市选择</h4>
                                    <div class="form-group row">
                                        <label class="col-md-2 col-form-label">城市选择</label>
                                        <div class="col-md-10">
                                            <!-- 只保留onchange调用，不传递任何参数 -->
                                            <select onchange="changeCity()" name="defaultCity" class="form-control">
                                                {% for i in citiesList %}
                                                    {% if i == defaultCity %}
                                                        <option selected value="{{ i }}">{{ i }}</option>
                                                    {% else %}
                                                        <option value="{{ i }}">{{ i }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- end col -->
                    </div> <!-- end row -->
                    <div class="row">
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="header-title">{{ defaultCity }} - 房屋装修情况分析</h4>
                                    <div id="main" style="width: 100%;height:450px">

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="header-title">{{ defaultCity }} - 房屋类型分析</h4>
                                    <div id="mainTwo" style="width: 100%;height:450px">

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="header-title">{{ defaultCity }} - 区域房源密度</h4>
                                    <div id="regionChart" style="width: 100%;height:450px">

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="header-title">{{ defaultCity }} - 房间数分布</h4>
                                    <div id="mainfour" style="width: 100%;height:450px">

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="header-title">{{ defaultCity }} - 房屋地区价格分布</h4>
                                    <div id="priceStackChart" style="width: 100%;height:450px">

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="header-title">{{ defaultCity }} - 热门标签词云图</h4>
                                    <div id="tagsCloud" style="width: 100%;height:450px">

                                    </div>
                                </div>
                            </div>
                        </div>


                    </div> <!-- end row -->

                </div>
                <!-- end container-fluid -->
            </div>
            <!-- end page-content-wrapper -->
        </div>
        <!-- End Page-content -->


        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-6">
                    </div>
                    <div class="col-sm-6">
                        <div class="text-sm-right d-none d-sm-block">
                            Copyright &copy; 2025<a target="_blank" href="#">链家网房屋数据分析预测系统</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <!-- end main content-->

</div>
<!-- END layout-wrapper -->


<!-- Right bar overlay-->
<div class="rightbar-overlay"></div>

<!-- JAVASCRIPT -->
<script>
    function changeCity() { // 用function声明，避免箭头函数可能的作用域问题
        // 直接通过name属性定位select（简单粗暴，必能找到）
        const selectElement = document.querySelector('select[name="defaultCity"]');
        // 强制获取value（此时select一定有选中项，value不可能为undefined）
        const selectedCity = selectElement.value;
        // 跳转逻辑
        const timestamp = new Date().getTime();
        window.location.href = '/page/typeChar?city=' + selectedCity + '&_t=' + timestamp;
    }
</script>
<script src="/static/echarts.min.js"></script>
<script>
    const chartDom = document.getElementById('main');
    const myChart = echarts.init(chartDom);
    let option;

    option = {
        title: {
            text: '装修情况占比',
            left: 'center'
        },
        tooltip: {
            trigger: 'item'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [
            {
                name: '装修情况个数',
                type: 'pie',
                radius: '50%',
                data: {{ typeCheOneData | tojson }},
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };

    option && myChart.setOption(option);

</script>
<script>
    const chartDomTwo = document.getElementById('mainTwo');
    const myChartTwo = echarts.init(chartDomTwo);
    let optionTwo;

    optionTwo = {
        title: {
            text: '房屋类型占比',
            left: 'center'
        },
        tooltip: {
            trigger: 'item'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [
            {
                name: '房屋类型个数',
                type: 'pie',
                roseType: "radius",
                radius: ['40%', '55%'],
                data: {{ typeCheTwoData | tojson }},
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };

    optionTwo && myChartTwo.setOption(optionTwo);

</script>
<script>
    // 区域房源数量堆叠柱状图
    try {
        const regionData = {{ regionData | tojson }};
        console.log('区域堆叠图数据:', regionData);

        if (!regionData || !regionData.categories || regionData.categories.length === 0) {
            throw new Error('没有区域数据');
        }

        const regionDom = document.getElementById('regionChart');
        const regionChart = echarts.init(regionDom);

        const option = {
            title: {
                text: '各区域不同类型房源数量',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function(params) {
                    let result = `<b>${params[0].name}</b><br>`;
                    let total = 0;

                    params.forEach(item => {
                        result += `${item.seriesName}: ${item.value} 套<br>`;
                        total += item.value;
                    });

                    result += `<b>总计: ${total} 套</b>`;
                    return result;
                }
            },
            legend: {
                type: 'scroll',  // 当类型过多时支持滚动
                orient: 'horizontal',
                bottom: 10,
                pageButtonItemGap: 5
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: regionData.categories,
                axisLabel: {
                    rotate: 45,  // 旋转标签避免重叠
                    interval: 0
                }
            },
            yAxis: {
                type: 'value',
                name: '房源数量'
            },
            series: regionData.series
        };

        regionChart.setOption(option);

        // 响应窗口大小变化
        window.addEventListener('resize', () => {
            regionChart.resize();
        });
    } catch (error) {
        console.error('区域堆叠图渲染失败:', error);
        // 显示错误信息
    }
</script>

<script>
    const chartDomFour = document.getElementById('mainfour');
    const myChartFour= echarts.init(chartDomFour);
    let optionFour;

    optionFour = {
        title: { text: '房间数分布占比', left: 'center' },
        tooltip: { trigger: 'item' },
        legend: { orient: 'horizontal', bottom: 0 },
        series: [{
            name: '房间数',
            type: 'pie',
            radius: '60%',
            data: {{ roomsData | tojson }},
            label: { formatter: '{b}: {c}套 ({d}%)' }  // 显示数量和百分比
        }]
    };

    optionFour && myChartFour.setOption(optionFour);
</script>

<script>
    // 区域房屋类型均价堆叠图
    try {
        // 获取后端传递的数据
        const stackData = {{ region_price_stack_data | tojson }};
        console.log('堆叠图原始数据:', stackData);

        // 数据验证
        if (!stackData || stackData.length === 0) {
            throw new Error('没有可用的价格数据');
        }

        // 提取区域列表
        const regions = stackData.map(item => item.region);

        // 提取所有房屋类型（去重）
        const houseTypes = [];
        stackData.forEach(regionItem => {
            regionItem.house_types.forEach(typeItem => {
                if (!houseTypes.includes(typeItem.type)) {
                    houseTypes.push(typeItem.type);
                }
            });
        });

        // 构建系列数据
        const series = [];
        houseTypes.forEach(type => {
            const data = [];
            stackData.forEach(regionItem => {
                // 查找当前区域中该类型房屋的均价
                const typeData = regionItem.house_types.find(item => item.type === type);
                data.push(typeData ? typeData.average_price : 0);
            });

            series.push({
                name: type,
                type: 'bar',
                stack: 'total',  // 堆叠配置
                data: data,
                itemStyle: {
                    // 为不同类型设置区分颜色
                    color: function(params) {
                        const colors = [
                            '#5470c6', '#91cc75', '#fac858', '#ee6666',
                            '#73c0de', '#3ba272', '#fc8452', '#9a60b4'
                        ];
                        return colors[params.seriesIndex % colors.length];
                    }
                },
                label: {
                    show: false,  // 默认不显示标签（数据太多时会重叠）
                    position: 'insideTop',
                    formatter: '{c} 元'
                }
            });
        });

        // 初始化图表
        const chartDom = document.getElementById('priceStackChart');
        const myChart = echarts.init(chartDom);

        // 图表配置
        const option = {
            title: {
                text: '各区域不同类型房屋均价堆叠图',
                left: 'center',
                textStyle: {
                    fontSize: 16
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },
                formatter: function(params) {
                    let result = `<b>${params[0].name}</b><br>`;
                    let total = 0;

                    params.forEach(item => {
                        if (item.value > 0) {
                            result += `${item.seriesName}: ${item.value.toFixed(2)} 元/㎡<br>`;
                            total += item.value;
                        }
                    });

                    result += `<b>总计: ${total.toFixed(2)} 元/㎡</b>`;
                    return result;
                }
            },
            legend: {
                type: 'scroll',  // 支持滚动（类型太多时）
                orient: 'horizontal',
                bottom: 10,
                data: houseTypes
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '15%',  // 预留更多底部空间给图例
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: regions,
                axisLabel: {
                    rotate: 45,  // 旋转标签防止重叠
                    interval: 0,
                    fontSize: 12
                }
            },
            yAxis: {
                type: 'value',
                name: '平均单价 (元/㎡)',
                nameTextStyle: {
                    fontSize: 12
                },
                axisLabel: {
                    formatter: '{value} 元'
                }
            },
            series: series
        };

        // 渲染图表
        myChart.setOption(option);

        // 响应窗口大小变化
        window.addEventListener('resize', () => {
            myChart.resize();
        });

        console.log('堆叠图渲染成功');
    } catch (error) {
        console.error('堆叠图渲染失败:', error);
        // 显示友好错误信息
        const errorDom = document.getElementById('priceStackChart');
        if (errorDom) {
            errorDom.innerHTML = `
                <div class="text-center text-danger" style="padding: 50px 0;">
                    <p>图表加载失败: ${error.message}</p>
                    <p>请尝试刷新页面或联系管理员</p>
                </div>
            `;
        }
    }
</script>

<!-- 引入 ECharts 和词云插件 -->
<script src="/static/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.0.0/dist/echarts-wordcloud.min.js"></script>
<script>
    // 等待 DOM 加载完成
    document.addEventListener('DOMContentLoaded', function() {
        try {
            console.log('开始渲染标签词云图...');
            // 检查数据是否存在
            const tagsData = {{ tagsData | tojson }};
            console.log('原始标签数据:', tagsData);

            if (!tagsData || tagsData.length === 0) {
                throw new Error('标签数据为空');
            }

            // 优化：过滤低频标签
            const filteredTags = tagsData.filter(tag => tag.value >= 3);
            const finalTags = filteredTags.length > 5 ? filteredTags : tagsData;
            console.log('优化后标签数据:', finalTags);

            // 检查 DOM 元素是否存在
            const tagsDom = document.getElementById('tagsCloud');
            if (!tagsDom) {
                throw new Error('找不到词云图容器');
            }

            // 初始化 ECharts
            const tagsChart = echarts.init(tagsDom);
            if (!tagsChart) {
                throw new Error('ECharts 初始化失败');
            }

            // 配置词云图
            const tagsOption = {
                title: {
                    text: '热门房源标签',
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    show: true,
                    formatter: function(params) {
                        return `标签: ${params.data.name}<br>出现次数: ${params.data.value}`;
                    }
                },
                series: [{
                    type: 'wordCloud',
                    gridSize: 10,  // 适当增加字间距
                    sizeRange: [16, 50],  // 调整字体大小范围
                    rotationRange: [-45, 0, 45, 90],
                    shape: 'circle',
                    drawOutOfBound: false,  // 不绘制超出边界的文字
                    textStyle: {
                        normal: {
                            color: function() {
                                // 使用更鲜明的颜色
                                const colors = [
                                    '#1f77b4', '#aec7e8', '#ff7f0e', '#ffbb78',
                                    '#2ca02c', '#98df8a', '#d62728', '#ff9896',
                                    '#9467bd', '#c5b0d5', '#8c564b', '#c49c94'
                                ];
                                return colors[Math.floor(Math.random() * colors.length)];
                            }
                        },
                        emphasis: {
                            shadowBlur: 10,
                            shadowColor: '#333'
                        }
                    },
                    data: finalTags
                }]
            };

            // 设置图表配置
            tagsChart.setOption(tagsOption);

            // 响应窗口大小变化
            window.addEventListener('resize', () => {
                tagsChart.resize();
            });

            console.log('标签词云图渲染成功');
        } catch (error) {
            console.error('标签词云图渲染失败:', error);
            const errorMsg = document.createElement('div');
            errorMsg.className = 'text-danger text-center mt-5';
            errorMsg.textContent = `词云图加载失败: ${error.message}`;
            document.getElementById('tagsCloud')?.appendChild(errorMsg);
        }
    });
</script>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/metisMenu.min.js"></script>
<script src="/static/js/simplebar.min.js"></script>
<script src="/static/js/waves.min.js"></script>
<script src="/static/js/bundle.js"></script>
<script src="/static/js/jquery.dataTables.min.js"></script>
<script src="/static/js/dataTables.bootstrap4.min.js"></script>
<script src="/static/js/dataTables.buttons.min.js"></script>
<script src="/static/js/buttons.bootstrap4.min.js"></script>
<script src="/static/js/jszip.min.js"></script>
<script src="/static/js/buttons.html5.min.js"></script>
<script src="/static/js/buttons.print.min.js"></script>
<script src="/static/js/buttons.colVis.min.js"></script>
<script src="/static/js/dataTables.responsive.min.js"></script>
<script src="/static/js/responsive.bootstrap4.min.js"></script>
<script src="/static/js/datatables.init.js"></script>
<script src="/static/js/app.js"></script>

</body>
</html>
